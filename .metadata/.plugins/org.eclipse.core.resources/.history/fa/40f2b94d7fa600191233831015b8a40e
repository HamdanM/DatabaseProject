import java.io.IOException;
import java.io.PrintWriter;
import java.sql.DriverManager;
import java.sql.SQLException;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.Statement;
import java.sql.PreparedStatement;
//import java.sql.Connection;
//import java.sql.PreparedStatement;
import java.sql.ResultSet;
//import java.sql.Statement;
import java.util.ArrayList;
import java.util.List;
/**
 * Servlet implementation class Connect
 */
@WebServlet("/PeopleDAO")
public class PeopleDAO extends HttpServlet {     
	private static final long serialVersionUID = 1L;
    
    /**
     * @see HttpServlet#HttpServlet()
     */
    public ControlServlet() {
        super();
        // TODO Auto-generated constructor stub
    }
    public static void disableWarning() {
        System.err.close();
        System.setErr(System.out);
    }
	/**
	 * @see HttpServlet#doGet(HttpServletRequest request, HttpServletResponse response)
	 */
	protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		// TODO Auto-generated method stub
		 System.err.close();
	        System.setErr(System.out);
		String action = request.getServletPath();
		System.out.println(action);
		String name = request.getParameter("username");
		System.out.println(name);
		System.out.println("we are linked");
		try {
			switch (action) {
			case "/build":
				System.out.println("we are inside build");
				buildDatabase(request, response);
				break;
			case "/login":
				System.out.println("we are inside login");
				loginUser(request, response);
				break;
			case "/register":
				System.out.println("we are inside register");
				registerUser(request, response);
				break;
			case "/search":
				System.out.println("we are inside search ");
				searchItem(request, response);
				break;
			case "/insertitem":
				System.out.println("we are inside insertItem");
				insertItem(request, response);
				break;
			case "/insertreview":
				System.out.println("we are inside insertReview");
				insertReview(request, response);
				break;
			case "/sellers":
				System.out.println("we are inside sellers");
				sellers(request, response);
				break;
			case "/list":
				System.out.println("we are inside list");
				listItems(request, response);
				break;
				
			default:
				System.out.println("Error 404");
				break;
			}
		}
		catch (SQLException ex) { 
			throw new ServletException(ex);
		}
		
		
	}
	

	protected void buildDatabase(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException, SQLException {
		InitializeDatabase.build();
		
		System.out.println("We are linked");
		RequestDispatcher dispatcher = request.getRequestDispatcher("initializeDatabase.jsp");
		dispatcher.forward(request, response);
		// TODO Auto-generated method stub
		response.getWriter().append("Served at: ").append(request.getContextPath());		
	}
	
	protected void loginUser(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException, SQLException {
		boolean found = false;
		Login login = new Login();
		System.out.println("We are linked");
		String username = request.getParameter("username");
		String password = request.getParameter("password");
		System.out.println(username);
		System.out.println(password);
		found = Login.login(username, password);
		System.out.println(found);
		response.sendRedirect("login.jsp");
		request.setAttribute("found", found);

		RequestDispatcher dispatcher = request.getRequestDispatcher("jfunny.jsp");
		dispatcher.forward(request, response);
		// TODO Auto-generated method stub
		//response.getWriter().append("Served at: ").append(request.getContextPath());		
	}

	protected void registerUser(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException, SQLException {
		Register register = new Register();
		System.out.println("We are linked");
		String username = request.getParameter("Username");
		String password = request.getParameter("Password");
		String firstname = request.getParameter("FirstName");
		String lastname = request.getParameter("LastName");
		String email = request.getParameter("Email");
		String gender = request.getParameter("Gender");
		String age = request.getParameter("Age");
		Register.register(username, password, firstname, lastname, email, gender, age);
		request.setAttribute("register", register);
		RequestDispatcher dispatcher = request.getRequestDispatcher("register.jsp");
		dispatcher.forward(request, response);
		// TODO Auto-generated method stub
		response.getWriter().append("Served at: ").append(request.getContextPath());		
	}
	
	
	protected void searchItem(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException, SQLException {
		
		Items item = new Items();
		String username = request.getParameter("Username");
		String title = request.getParameter("Title");
		String description = request.getParameter("Description");
		
		Items.insertItem(username, title, description);
		
		request.setAttribute("item", item );
		RequestDispatcher dispatcher = request.getRequestDispatcher("itemList.jsp");
		dispatcher.forward(request, response);
		// TODO Auto-generated method stub
		response.getWriter().append("Served at: ").append(request.getContextPath());
		
	}

	protected void insertItem(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException, SQLException {
		Items item = new Items();

		String searchitem = request.getParameter("item");
		
		item.searchItem(searchitem);
		
		request.setAttribute("item", item );
		RequestDispatcher dispatcher = request.getRequestDispatcher("search.jsp");
		dispatcher.forward(request, response);
		// TODO Auto-generated method stub
		response.getWriter().append("Served at: ").append(request.getContextPath());
		
		
	}
	
protected void insertReview(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException, SQLException {
		
	Reviews review = new Reviews();

	String itemID = request.getParameter("ItemID");
	String userid = request.getParameter("User_UserID");
	String score = request.getParameter("Score");
	String shortremark = request.getParameter("ShortRemark");
	
	Reviews.insertReview(itemID, userid, score, shortremark);
	
	request.setAttribute("reivew", review );
	RequestDispatcher dispatcher = request.getRequestDispatcher("addReview.jsp");
	dispatcher.forward(request, response);
	// TODO Auto-generated method stub
	response.getWriter().append("Served at: ").append(request.getContextPath());
		
	}
protected void sellers(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException, SQLException {
	Users user = new Users();
	
	user.listUsers();
	request.setAttribute("users", user);
	RequestDispatcher dispatcher = request.getRequestDispatcher("seller.jsp");
	dispatcher.forward(request, response);
	// TODO Auto-generated method stub
	response.getWriter().append("Served at: ").append(request.getContextPath());
	
}
protected void listItems(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException, SQLException {
	Items items = new Items();
	
	
	String username=request.getParameter("item");
	String title=request.getParameter("title");;
	String description=request.getParameter("description");;
	
	items.listItem( username, title, description);
	request.setAttribute("items", items);
	RequestDispatcher dispatcher = request.getRequestDispatcher("itemList.jsp");
	dispatcher.forward(request, response);
	// TODO Auto-generated method stub
	response.getWriter().append("Served at: ").append(request.getContextPath());
}
	
	/**
	 * @see HttpServlet#doPost(HttpServletRequest request, HttpServletResponse response)
	 */
	protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		// TODO Auto-generated method stub
		doGet(request, response);
		InitializeDatabase build = new InitializeDatabase();
		
	}

}
